name: E2E Tests

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:

env:
  MSSQL_SA_PASSWORD: E2ETest123!Strong
  MSSQL_PORT: 1434
  MSSQL_CONTAINER_NAME: sqlserver-e2e

jobs:
  e2e:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v3

      - name: Start SQL Server
        run: docker compose -f docker/docker-compose.yml up -d

      - name: Wait for SQL Server to be healthy
        run: |
          echo "Waiting for SQL Server to be ready..."
          timeout 60 bash -c 'until docker compose -f docker/docker-compose.yml ps | grep -q "healthy"; do sleep 2; done'
          echo "SQL Server is ready!"

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: client/package-lock.json

      - name: Restore .NET dependencies
        run: dotnet restore
        working-directory: ./server

      - name: Build API
        run: dotnet build --no-restore --configuration Release
        working-directory: ./server

      - name: Create Database
        run: docker exec ${{ env.MSSQL_CONTAINER_NAME }} /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "${{ env.MSSQL_SA_PASSWORD }}" -C -Q "IF NOT EXISTS (SELECT * FROM sys.databases WHERE name = 'DigitalStorefront') CREATE DATABASE DigitalStorefront;"

      - name: Run Database Migrations
        run: dotnet run --project DatabaseManagement --no-build --configuration Release -- --reset "Server=localhost,${{ env.MSSQL_PORT }};Database=DigitalStorefront;User Id=sa;Password=${{ env.MSSQL_SA_PASSWORD }};TrustServerCertificate=True"
        working-directory: ./server
        env:
          ADMIN_USERNAME: ${{ secrets.ADMIN_USERNAME }}
          ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
          AppSettings__PasswordKey: ${{ secrets.APPSETTINGS_PASSWORD_KEY }}

      - name: Install frontend dependencies
        run: npm ci
        working-directory: ./client

      - name: Install Playwright browsers
        run: npx playwright install chromium
        working-directory: ./client

      - name: Start API server
        run: |
          dotnet run --no-build --configuration Release &
          echo "Waiting for API to start..."
          timeout 30 bash -c 'until curl -s http://localhost:5000/health > /dev/null 2>&1; do sleep 1; done'
          echo "API is ready!"
        working-directory: ./server/API
        env:
          ASPNETCORE_ENVIRONMENT: E2E
          ASPNETCORE_URLS: http://localhost:5000
          ConnectionStrings__DefaultConnection: "Server=localhost,${{ env.MSSQL_PORT }};Database=DigitalStorefront;User Id=sa;Password=${{ env.MSSQL_SA_PASSWORD }};TrustServerCertificate=True"
          AppSettings__PasswordKey: ${{ secrets.APPSETTINGS_PASSWORD_KEY }}

      - name: Run E2E tests
        run: npx playwright test --grep-invert "Checkout"  # Avoiding Stripe integration issues in CI
        working-directory: ./client
        env:
          VITE_API_URL: http://localhost:5000
          VITE_PLAYWRIGHT: "true"

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-report
          path: client/playwright-report/
          retention-days: 7

      - name: Stop E2E containers
        if: always()
        run: docker rm -f ${{ env.MSSQL_CONTAINER_NAME }} && docker volume rm docker_sqlserverdata 2>/dev/null || true
